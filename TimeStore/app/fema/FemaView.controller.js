/* global _ */
(function ()
{
  "use strict";
  angular.module('timestoreApp')
    .controller('FemaViewController', ['$scope', 'viewOptions', 'timestoredata', '$routeParams', FemaTimecard]);

  function FemaTimecard($scope, viewOptions, timestoredata, $routeParams)
  {

    //$scope.showProgress = true;
    $scope.filtered = [];
    $scope.Message = '';
    $scope.timeData = [];
    $scope.rawData = [];
    $scope.selectedGroup = -1;
    $scope.selectedPPI = 0;
    $scope.GroupsByPayperiodData = GroupsByPayPeriod();

    //$scope.processSelectedGroup = function ()
    //{
    //  if ($scope.selectedGroup === -1) return;
    //  var g = $scope.GroupsByPayperiodData[$scope.selectedGroup];
    //  var ppi = timestoredata.getPayPeriodIndex(moment(g.ppe, 'M/D/YYYY'));
    //  if (ppi !== $scope.selectedPPI)
    //  {
    //    $scope.showProgress = true;
    //    $scope.Message = '';
    //    timestoredata.getFemaData(ppi).then(function (data)
    //    {
    //      $scope.rawData = data;
    //      $scope.selectedPPI = ppi;
    //      $scope.timeData = FilterRawData($scope.rawData, g.employees);
    //      if (data.length === 0)
    //      {
    //        $scope.Message = 'No timecards found.';
    //      }
    //      $scope.showProgress = false;
    //    });
    //  }
    //  else
    //  {
    //    $scope.timeData = FilterRawData($scope.rawData, g.employees);
    //  }
    //};

    $scope.processAllGroups = function ()
    {
      $scope.showProgress = true;
      //var g = $scope.GroupsByPayperiodData[$scope.selectedGroup];
      var ppis = [];
      var es = [];
      var c = {};
      var raw = [], filtered = [];
      var ppi, currentPPI;
      var g = $scope.GroupsByPayperiodData;
      for (var i = 0; i < g.length; i++)
      {

        ppi = timestoredata.getPayPeriodIndex(moment(g[i].ppe, 'M/D/YYYY'));
        //console.log(g[i].ppe, g[i].employees, ppi);
        var x = ppis.indexOf(ppi);
        if (x === -1)
        {
          ppis.push(ppi);
          es.push(g[i].employees);
        }
        else
        {
          //for (var j = 0; j < g[i].employees.length; j++)
          //{
          //  if (es[x].indexOf(g[i].employees[j]) > -1)
          //  {
          //    console.log('duplicate employee', g[i].employees[j], es[x]);
          //  }
          //  else
          //  {
          //    es[x].push(g[i].employees[j]);
          //  }
          //}
          es[x].push.apply(es[x], g[i].employees);
        }
      }
      //console.log('ppi', ppis, 'employees', es);
      getData(ppis.pop(), es.pop(), ppis, es);
      //console.log('all filtered', filtered);
      $scope.showProgress = false;
    };

    function getData(ppi, employees, ppis, es)
    {
      if (!ppi)
      {

        $scope.timeData = $scope.filtered.sort(function (a, b)
        {
          //var e1 = parseInt(a['employeeID']);
          //var e2 = parseInt(b['employeeID']);
          //var d1 = new Date(a['payPeriodStart']);
          //var d2 = new Date(b['payPeriodStart']);
          //return e1 === e2 ? d1 - d2 : e1 - e2;
          return true;
        });
        //$scope.timeData = $scope.filtered;
        console.log('sorted', $scope.timeData);
        return;
      }
      timestoredata.getFemaData(ppi).then(function (data)
      {
        //raw = data;
        //currentPPI = ppi;        
        var fd = FilterRawData(data, employees);
        $scope.filtered.push.apply($scope.filtered, fd);
        getData(ppis.pop(), es.pop(), ppis, es);

      });
    }


    $scope.processAllGroups();

    viewOptions.viewOptions.showSearch = false;
    viewOptions.viewOptions.share();
    //$scope.ppdIndex = timestoredata.getPayPeriodIndex(moment($routeParams.payPeriod, 'YYYYMMDD'));


    //console.log('pay period data', $scope.GroupsByPayperiodData);
    //timestoredata.getFemaData($scope.ppdIndex).then(ProcessData, function () { });

    function FilterRawData(raw, employees)
    {
      return _.filter(raw, function (x)
      {
        return employees.indexOf(parseInt(x.employeeID)) !== -1;
      });
      //console.log('timedata', $scope.timeData);
    }

    function GroupsByPayPeriod()
    {
      return [
        {
          "ppe": "9/3/2019",
          "employees": [
            1042,
            1101,
            1145,
            1158,
            1173,
            1259,
            1280,
            1298,
            1365,
            1379,
            1552,
            2051,
            2438,
            2505,
            2655,
            2823,
            2863,
            2938,
            3027,
            1304,
2695,
2381,
3042,
2910,
2774,
2634,
2786,
2275,
2037,
2837,
2602,
2191,
2563,
2839,
2908,
2852,
2851,
2983,
1266,
3043,
1896,
2810,
2932,
2229,
1433,
3028,
2994,
2081,
2982,
2988,
1205,
1499,
1065,
2858,
2377,
1989,
2985,
1233,
2929,
2857,
2995,
2784,
1224,
1367,
1566,
2653,
1255,
2804,
2805,
2506,
2978,
2654,
1501,
3019,
3021,
2859,
2474,
2906,
3018,
2949,
1508,
2753,
2812,
1359,
2992,
1374,
2991,
2413,
2757,
2754,
2604,
2808,
3015,
2231,
3029,
3026,
1889,
3023,
1223,
1893,
1452,
2990,
2399,
1222,
1523,
1987,
1303,
2410,
2019,
2464,
2644,
2772,
1251,
2701,
1553,
2048,
1277,
2746,
1377,
1182,
1241,
1204,
2206,
3020,
1109,
2546,
1963,
2931,
2761,
2969,
2860,
3011,
1849,
2782,
1324,
2554,
2535,
1217,
2815,
2702,
2912,
2977,
3017,
2082,
2794,
2939,
2163,
1721,
2613,
2469,
1127,
1420,
2937,
2907,
1326,
2984,
1830,
2855,
2923,
1417,
2877,
2987,
2952,
1347,
1375,
1291,
2940,
2471,
1076,
2029,
1002,
2849,
2942,
2832,
3014,
2876,
2192,
2097,
1313,
1808,
1483,
2007,
2846,
1816,
1845,
2060,
1270,
2941,
2769,
2986,
2348,
2564,
2965,
3024,
2439,
2497,
2258,
2797,
2015,
2675,
1323,
1879,
2713,
1068,
2197,
1151,
1482,
1060,
2572,
1479,
2276,
1134,
1201,
2560,
1492,
2549,
1549,
1385,
1824,
1155,
2196,
1341,
3045,
1408,
1123,
2512,
1474,
2180,
3025,
2919,
2519,
2547,
1436,
1288,
2041,
3041,
2850,
2375,
2744,
1344,
2225,
2710,
2605,
2875,
2427,
1361,
2033,
2493,
2704,
1848,
2813,
2553,
2273,
2385,
2684,
2833,
2809,
2950,
2989,
2947,
2792,
1990,
1397,
2933,
2541,
2685,
2419,
2282,
2232,
2711,
1188,
2641,
1267,
1978,
2532,
1328,
1140,
1159,
2266,
2057,
1398,
2516,
2617,
1563,
2917,
2951,
1114,
1506,
2576,
1389,
2008,
2216,
3022,
1460,
2559,
1191,
2127,
2811,
3010,
1461,
2555,
1124,
3044,
3006,
1167,
1414,
1340,
1384,
1168,
1063,
1697,
1480,
2755,
3016,
2009,
2681,
1079,
2714,
1117,
2551,
2022,
3008,
1212,
2722,
1245,
1012,
1569,
3009,
2500,
1125,
1030,
1707,
2677,
1308,
2964,
1719,
1064,
2220,
2948,
1157,
1067,
2262,
1229,
1327,
2968,
1789,
1187,
1075,
1090,
1337,
1031,
2570,
1066,
2693,
1099,
1349,
1019,
2530,
1567,
2460,
1459,
1759,
2756,
2619,
2861
          ]
        }
      ];
    }

    // CAT B 17333 PW Callcenter after first 30 data
    // [{"ppe": "10/17/2017", "employees": [1270,1304,1313,1433,1508,1719,1816,2037,2097,2282,2474,2489,2493,2704,2710,2742,2753,2768,2819,2849,2855]}, {"ppe": "10/31/2017", "employees": [1184,1304,1433,1483,1508,1719,1848,1889,2033,2282,2348,2474,2489,2493,2644,2704,2753,2759,2794,2819,2826]}, {"ppe": "11/14/2017", "employees": [1433,1508,1719,1830,1889,2037,2644,2704,2753,2758,2794,2819,2834,2849]}, {"ppe": "11/28/2017", "employees": [1184,1341,1719,1889,2258,2471,2634,2644,2704,2794,2819]}, {"ppe": "12/12/2017", "employees": [1270,1304,1719,1889,2097,2348,2634,2644,2704,2753,2794,2809,2826,2832]}, {"ppe": "12/26/2017", "employees": [2644]}]

    // Signs FAL data
    // [{"ppe": "9/19/2017", "employees": [1066,1067,1157,1306,1707,1759,2262,2619,2756]}, {"ppe": "10/3/2017", "employees": [1067,1759,2619]}];

    // Public Safety Debris Staffing from 10-18 through 01-01-2018
    // [{"ppe": "10/31/2017", "employees": [1130,1202,1237,1259,1269,1383,1404,1552,1579,1584,1713,1993,1997,2052,2241,2508,2670,2716]}, {"ppe": "11/14/2017", "employees": [1130,1202,1237,1259,1269,1404,1552,1579,1584,1713,1993,2039,2241,2670,2716]}, {"ppe": "11/28/2017", "employees": [1130,1202,1237,1259,1269,1404,1552,1579,1584,1713,1993,2039,2670]}, {"ppe": "12/12/2017", "employees": [1237,1404,1584,1713]}];

    // Public Safety Coverage Staffing from 10-04-2017 through 12-12-2017
    // [{"ppe": "10/17/2017", "employees": [1237,1589,1679,2481,2526,2584,2590,2592,2597,2628,2666,2707,2715,2748,2749,2765,2798,2802,2803,2806,2821,2822,2827,2830,2863,2864,2865,2866,2867,2868,2870,2871,2874]}, {"ppe": "10/31/2017", "employees": [1425,2112,2254,2414,2481,2592,2715,2795,2796,2821,2827,2869,2870,2874]}, {"ppe": "11/14/2017", "employees": [2481,2485,2523,2526,2592,2597,2601,2707,2806,2867,2869]}, {"ppe": "11/28/2017", "employees": [2116,2526,2527,2584,2592,2666,2669,2718,2796,2806,2821,2822,2830,2867,2870,2874]}, {"ppe": "12/12/2017", "employees": [2590,2707,2801,2867]}];
    // Hurricane Irma Data
    // Animal Control - CAT E
    // [{"ppe": "9/19/2017", "employees": [1151,1288]}, {"ppe": "10/3/2017", "employees": [1134,1151,1288,1479,1663,2519,2547,2713]}, {"ppe": "10/17/2017", "employees": [1479,2519,2547,2713,2818]}, {"ppe": "10/31/2017", "employees": [1151,1288,1479,1506,1879,2276,2547,2713,2818]}, {"ppe": "11/14/2017", "employees": [1151,1879,2741]}, {"ppe": "11/28/2017", "employees": [1482]}, {"ppe": "12/12/2017", "employees": [1879,2713]}, {"ppe": "12/26/2017", "employees": [1134,1663]}, {"ppe": "1/9/2018", "employees": [2713]}];
    // Call center 27170 BCC Staff thru 9-19-2017
    // [{"ppe": "10/3/2017", "employees": [1304,1349,1433,1508,1719,1848,2037,2258,2273,2282,2489,2633,2634,2704,2753,2794,2819,2849,2850,2861]}, {"ppe": "10/17/2017", "employees": [1127,1270,1304,1313,1433,1508,1719,1816,2037,2060,2097,2282,2474,2489,2493,2648,2650,2704,2710,2742,2753,2768,2819,2849,2855]}];
    // Knights Marina Forced Account Labor
    // [{"ppe": "9/19/2017", "employees": [1043,1323,1451,1492,1824,2041,2196,2264,2549,2553]}, {"ppe": "10/3/2017", "employees": [1408,1824,2196]}, {"ppe": "10/17/2017", "employees": [1451,1824]}, {"ppe": "10/31/2017", "employees": [1824,2196]}, {"ppe": "1/23/2018", "employees": [1323,1492,2180,2197,2549]}, {"ppe": "2/6/2018", "employees": [1323,1492,1824,2180,2196,2197,2549]}, {"ppe": "2/20/2018", "employees": [1492,2180,2197,2549]}];
    // BCC Staff through 09-19
    // [{"ppe": "9/19/2017", "employees": [1012,1019,1028,1030,1031,1043,1063,1064,1065,1066,1067,1073,1074,1075,1076,1078,1079,1080,1114,1117,1121,1124,1125,1127,1140,1151,1157,1159,1167,1168,1181,1182,1184,1187,1191,1204,1212,1216,1217,1222,1229,1235,1241,1245,1255,1266,1267,1277,1281,1291,1303,1304,1306,1308,1313,1324,1326,1327,1328,1335,1337,1340,1341,1344,1347,1349,1361,1369,1377,1384,1387,1389,1397,1398,1408,1414,1420,1433,1436,1445,1451,1452,1459,1460,1461,1474,1480,1492,1501,1521,1549,1563,1567,1569,1707,1719,1721,1729,1759,1789,1808,1824,1848,1849,1863,1887,1889,1892,1896,1963,1969,1978,1987,1989,2008,2009,2018,2019,2022,2033,2037,2057,2070,2081,2082,2097,2127,2163,2191,2192,2196,2206,2216,2220,2225,2229,2258,2262,2264,2266,2273,2375,2377,2399,2410,2427,2439,2445,2457,2459,2469,2471,2474,2493,2497,2500,2512,2516,2530,2532,2535,2541,2542,2549,2551,2553,2554,2555,2558,2559,2563,2570,2572,2576,2605,2617,2619,2633,2634,2641,2644,2648,2650,2652,2659,2675,2679,2681,2684,2695,2696,2701,2704,2710,2711,2714,2722,2736,2737,2739,2745,2747,2753,2754,2755,2756,2761,2768,2769,2772,2774,2782,2783,2784,2786,2791,2793,2794,2797,2808,2810,2811,2813,2814,2815,2816,2819,2826,2832,2837,2838,2839,2846,2847,2849,2850,2851,2857,2858,2860,2861]}];
    // CAT B Data
    // Telestaff Fema Data PPE 09-19-2017
    // [{"ppe": "9/19/2017", "employees": [1042,1091,1093,1095,1101,1109,1130,1145,1158,1162,1169,1172,1173,1190,1199,1202,1258,1259,1262,1272,1280,1289,1298,1318,1365,1379,1383,1404,1422,1425,1456,1472,1530,1546,1552,1562,1579,1584,1674,1677,1678,1679,1684,1713,1839,1853,1883,1885,1970,1971,1973,1993,1994,1996,1999,2039,2046,2051,2052,2111,2112,2116,2235,2237,2238,2241,2245,2249,2251,2260,2347,2386,2389,2400,2435,2436,2438,2481,2484,2485,2487,2505,2509,2523,2525,2526,2527,2533,2539,2552,2567,2568,2579,2580,2583,2584,2586,2590,2593,2594,2596,2597,2598,2609,2628,2636,2655,2662,2664,2666,2667,2670,2707,2715,2716,2718,2719,2720,2728,2744,2748,2752,2765,2781,2785,2796,2798,2799,2803,2806,2821,2822,2824,2825,2827,2828,2830,2831,2835,2842,2848,2854,2862,2863,2864,2865,2866,2867,2868,2869,2870,2871,2872,2873,2874]}];
    // Telestaff Fema Data PPE 10-03-2017
    // [{"ppe": "10/3/2017", "employees": [1589,2112,2116,2481,2526,2579,2583,2592,2609,2627,2636,2669,2707,2720,2752,2785,2803,2822,2830,2863]}];
    // Telestaff Fema Data PPE 10-17-2017
    // [{"ppe": "10/17/2017", "employees": [1237,1589,1679,2481,2526,2584,2590,2592,2597,2628,2666,2707,2715,2748,2749,2765,2806,2821,2822,2827,2830]}];
    // Telestaff Fema Data PPE 10-31-2017
    // [{"ppe": "10/31/2017", "employees": [1425,2112,2254,2414,2481,2592,2715,2796,2821,2827,2869,2870,2874]}];
    // Timestore Fema Data PPE 09-19-2017

    // Timestore Fema Data PPE 10-03-2017
    // [{"ppe": "10/3/2017", "employees": [1030,1075,1090,1125,1204,1222,1251,1277,1304,1377,1508,1719,1879,1887,1987,2019,2041,2070,2081,2258,2273,2282,2410,2464,2493,2634,2704,2711,2742,2772,2813,2815,2818,2819,2849,2850,2851]}];
    // Timestore Fema Data PPE 10-17-2017
    // [{"ppe": "10/17/2017", "employees": [1030,1075,1125,1204,1222,1304,1508,1553,1719,1816,1887,1889,1989,2041,2081,2196,2197,2264,2273,2282,2385,2410,2464,2474,2493,2549,2701,2704,2710,2711,2742,2753,2818,2819,2849,2858]}];
    // Timestore Fema Data PPE 10-31-2017
    // [{"ppe": "10/31/2017", "employees": [1030,1125,1222,1241,1508,1719,1879,1889,2282,2410,2474,2493,2553,2644,2704,2753,2819]}];

    // CAT A Data
    // CAT A \Debris 10_03_2017
    // [{"ppe": "10/3/2017", "employees": [1202,1259,1269,1404,1562,1584,1713,1856,1997,2241,2670,2716]}]
    // CAT A \Debris 10-17-2017
    // [{"ppe": "10/17/2017", "employees": [1259,1269,1404,1579,1584,1713,1997,2039,2508,2670]}];
    // CAT A \Debris 10-31-2017
    // [{"ppe": "10/31/2017", "employees": [1130,1202,1237,1259,1269,1383,1404,1552,1579,1584,1713,1993,1997,2052,2241,2508,2670,2716]}];



    // Hurricane Matthew Data
    // Debris - Call Center - 30 day
    // [{"ppe": "10/18/2016", "employees": [1303,2377,2541]}, {"ppe": "11/1/2016", "employees": [1002,1083,1184,1303,1335,1349,1417,1433,1483,1523,1830,1848,1901,2029,2037,2192,2439,2489,2530,2634,2650,2659,2704,2750,2758,2759]}];
    // Debris - Call Center - 90 day
    // [{"ppe": "11/15/2016", "employees": [1083,1303,1326,1417,1433,1483,1808,1822,1837,1969,2007,2048,2097,2258,2439,2497,2650,2659,2758,2769]}, {"ppe": "11/29/2016", "employees": [1181,1347,1830,2048,2489,2650,2759]}, {"ppe": "12/13/2016", "employees": [2650]}]
    // Animal Control 
    // [{"ppe": "10/18/2016", "employees": [1175,1266,1896,2191,2229,2563,2726,2745,2766,2777,2778]}]
    // Public Safety Cat B
    // [{ "ppe": "10/18/2016", "employees": [1042, 1091, 1092, 1101, 1109, 1130, 1145, 1158, 1169, 1172, 1173, 1199, 1258, 1259, 1262, 1269, 1272, 1280, 1289, 1298, 1318, 1365, 1379, 1380, 1383, 1422, 1425, 1437, 1456, 1472, 1478, 1530, 1546, 1552, 1562, 1576, 1579, 1584, 1674, 1678, 1679, 1684, 1713, 1740, 1758, 1853, 1882, 1885, 1971, 1973, 1993, 1994, 1999, 2000, 2039, 2046, 2051, 2052, 2054, 2111, 2112, 2118, 2123, 2235, 2237, 2238, 2242, 2243, 2245, 2246, 2249, 2251, 2254, 2260, 2347, 2389, 2398, 2400, 2414, 2436, 2438, 2481, 2484, 2485, 2487, 2505, 2509, 2523, 2524, 2546, 2552, 2565, 2567, 2579, 2580, 2586, 2590, 2591, 2592, 2593, 2596, 2597, 2609, 2610, 2611, 2626, 2628, 2655, 2662, 2663, 2665, 2666, 2667, 2669, 2670, 2705, 2715, 2716, 2717, 2719, 2720, 2724, 2725, 2728, 2733, 2734, 2744, 2752, 2765, 2770, 2775, 2776, 2779, 2781, 2785] }];
    // pub works Grading cat b - not run yet.
    // [{"ppe": "10/18/2016", "employees": [1012,1028,1074,1079,1159,1167]}]
    // pub works Misc
    // [{"ppe": "10/4/2016", "employees": [1569]}, {"ppe": "10/18/2016", "employees": [1030,1063,1075,1080,1097,1117,1121,1124,1125,1140,1168,1191,1212,1245,1328,1337,1389,1414,1445,1460,1480,1569,1759,1892,1978,2018,2022,2057,2127,2216,2220,2515,2516,2551,2619,2677,2681,2703,2714,2735,2737,2747,2754,2791]}, {"ppe": "11/1/2016", "employees": [1245,1369,1863,2266,2515,2551,2604,2641,2703,2761]}, {"ppe": "11/15/2016", "employees": [ 2604 ]}]
    // pub works signs 
    // [{"ppe": "10/18/2016", "employees": [1066,1306,1449,1707,1759,2010,2262,2674]}]
    // Cat B Preliminary Timestore data
    // [{"ppe": "10/18/2016", "employees": [1019,1020,1065,1073,1078,1081,1181,1223,1233,1255,1266,1303,1335,1344,1347,1349,1356,1357,1359,1374,1483,1499,1501,1521,1523,1567,1729,1822,1887,1889,1969,1987,1989,2060,2081,2082,2097,2192,2231,2375,2377,2399,2427,2428,2445,2457,2459,2464,2474,2489,2490,2493,2500,2511,2513,2541,2542,2574,2604,2605,2614,2615,2630,2633,2644,2648,2650,2652,2685,2704,2710,2711,2742,2746,2753,2759,2783]}]

  }

})();